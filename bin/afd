#!/usr/bin/env node

const { initialize, start, getInstance } = require('../')
const { getIdentifier } = require('ara-identity/did')
const { info, error } = require('ara-console')
const { basename } = require('path')
const inquirer = require('inquirer')
const program = require('yargs')
const debug = require('debug')('afd')
const clip = require('cli-progress')
const rc = require('ara-runtime-configuration')()

const $0 = basename(process.argv[1] || package.name)

process.title = $0
process.on('unhandledRejection', onfatal)
process.on('uncaughtExeption', onfatal)

// program usage
program
  .usage('usage: $0 [-hDV] <command> [options]')
  .wrap(null)

// booleans
program
  .group([ 'help', 'version', 'debug' ], 'General Options:')
  .option('debug', {
    type: 'boolean',
    alias: 'D',
    describe: "Enable debug output"
  })
  .option('help', {
    alias: 'h',
    describe: "Show this help message"
  })
  .option('version', {
    alias: 'V',
    describe: "Show program version"
  })

// parameters
program
  .group([ 'identity', 'did' ], 'Command Options:')

program.option('identity', {
  alias: 'i',
  type: 'string',
  required: true,

  describe:
  `A valid, local, and resolvable Ara identity DID
  URI of the owner of the AFS. You will be
  prompted for the associated passphrase`,
})

program.option('did', {
  alias: 'd',
  type: 'string',
  describe:
  `A valid and resolvable Ara identity DID URI
  of an AFS.`,
})

program.command(
  'download',
  'Download AFS from network',
  // eslint-disable-next-line no-shadow
  program => program
    .usage('usage: $0 [-D] download [options]')
  , ondownload
)

program.command(
  'publish',
  'Host AFS for network',
  // eslint-disable-next-line no-shadow
  program => program
    .usage('usage: $0 [-D] publish [options]')
  , onpublish
)

program.command(
  'start',
  'Start the DCDN Node with the most recent configuration',
  // eslint-disable-next-line no-shadow
  program => program
    .usage('usage: $0 [-D] start [options]')
  , onstart
)

if (0 === program.argv._.length) {
  program.showHelp()
  process.exit(1)
}

if (program.argv.debug) {
  require('debug').enable('af*')
}

async function onstart(argv){
  info(`starting DCDN node`)

  let password = await getPassword()

  try {
    await start({
      password: password,
      userID: argv.identity,
    })
  } catch (e) {
    error(`Error occurred with starting DCDN Node`, e)
    return process.exit(1)
  }
}

async function ondownload(argv){

  let did = getIdentifier(argv.did || await getDid()) 

  info(`starting DCDN to download ${did}`)

  let password = await getPassword()

  let { maxCost } = await inquirer.prompt([ {
    type: 'input',
    name: 'maxCost',
    message:
    '\nPlease enter your max cost in Ara per download.\n' +
    'Price:'
  } ])

  let { maxPeers } = await inquirer.prompt([ {
    type: 'input',
    name: 'maxPeers',
    message:
    '\nPlease enter the maximum number of publishers you want to hire.\n' +
    'Price:'
  } ])

  try {
    await start({
      password: password,
      userID: argv.identity,
      did,
      download: true,
      upload: false,
      price: maxCost,
      maxPeers: maxPeers
    })

    const dcdn = await getInstance()
    attachDownloadVisualizer(did, dcdn)
    
  } catch (e) {
    error(`Error occurred while downloading ${did}`, e)
    return process.exit(1)
  }

  // Creates a progress visualizer bar in cli
  function attachDownloadVisualizer(id, dcdn) {
    const pBar = new clip.Bar({}, clip.Presets.shades_classic)
    dcdn.on('start', (did, total) => {
      if (id === did) pBar.start(total, 0)
    })
    dcdn.on('progress', (did, value) => {
      if (id === did) pBar.update(value)
    })
    dcdn.on('complete', (did) => {
      if (id === did) pBar.stop()
    })
  }
}

async function onpublish(argv){

  let did = getIdentifier(argv.did || await getDid()) 
  info(`starting DCDN to publish ${did}`)

  let password = await getPassword()

  let { farmingPrice } = await inquirer.prompt([ {
    type: 'input',
    name: 'farmingPrice',
    message:
    '\nPlease enter your price in Ara per upload.\n' +
    'Price:'
  } ])

  try {
    await start({
      password: password,
      userID: argv.identity,
      did,
      download: false,
      upload: true,
      price: farmingPrice,
    })
  } catch (e) {
    error(`Error occurred while publishing DID ${did}`, e)
    return process.exit(1)
  }
}

async function getPassword(){
  let { password } = await inquirer.prompt([ {
    type: 'password',
    name: 'password',
    message:
    'Please enter the passphrase associated with the node identity.\n' +
    'Passphrase:'
  } ])
  return password
}

async function getDid(){
  let { did } = await inquirer.prompt([ {
    type: 'string',
    name: 'did',
    message:
    'Please enter the DID associated with the AFS.\n' +
    'DID:'
  } ])
  return did
}

function onfatal(err) {
  if (err) {
    debug(err)
    error("fatal:", err.message)
  }
  process.exit(1)
}
